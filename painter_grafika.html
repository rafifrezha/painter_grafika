<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Mini Paint - Grafika Komputer IF-</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap 5 CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Google Fonts: Poppins -->
    <link
      href="https://fonts.googleapis.com/css?family=Poppins:400,600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        font-family: "Poppins", Arial, sans-serif;
        background: #f9fafb;
        color: #232946;
      }
      .toolbar {
        background: #fff;
        border-radius: 1.5rem;
        box-shadow: 0 8px 32px #0002, 0 2px 8px #eebf6320;
        padding: 2rem 1.2rem 2rem 1.2rem;
        margin: 2rem 0 2rem 2rem;
        position: fixed;
        left: 0;
        top: 0;
        height: calc(100vh - 4rem);
        width: 250px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem 0;
        overflow-y: auto;
        border: none;
        transition: box-shadow 0.2s;
      }
      .toolbar .tool-btn {
        width: 100%;
        min-width: 0;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: flex-start;
        gap: 14px;
        font-size: 16px;
        padding: 12px 16px;
        border-radius: 1rem !important;
        background: #f3f4f6;
        color: #232946;
        border: none !important;
        transition: background 0.18s, color 0.18s, box-shadow 0.18s,
          transform 0.12s;
        box-shadow: none;
        font-weight: 600;
        cursor: pointer;
        position: relative;
      }
      .toolbar .tool-btn.active,
      .toolbar .tool-btn:focus {
        background: #eebf63 !important;
        color: #232946 !important;
        box-shadow: 0 2px 12px #eebf6320;
        transform: scale(1.04);
      }
      .toolbar .tool-btn:hover {
        background: #ffe6b0 !important;
        color: #232946 !important;
        box-shadow: 0 2px 8px #eebf6320;
        transform: scale(1.03);
      }
      .toolbar .tool-btn i {
        font-size: 20px;
        color: #232946;
        min-width: 24px;
        text-align: center;
        transition: color 0.15s;
      }
      .toolbar .tool-btn[title]:hover:after {
        content: attr(title);
        position: absolute;
        left: 110%;
        top: 50%;
        transform: translateY(-50%);
        background: #232946;
        color: #fff;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 13px;
        white-space: nowrap;
        z-index: 2000;
        opacity: 0.95;
      }
      .toolbar-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: #232946;
        margin-bottom: 22px;
        margin-left: 4px;
        letter-spacing: 0.5px;
      }
      .toolbar-group {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 0.7rem;
        margin-bottom: 1.5rem;
      }
      .toolbar-label {
        font-size: 1rem;
        color: #232946;
        font-weight: 600;
        margin-bottom: 6px;
        margin-left: 2px;
      }
      .color-input-wrap {
        width: 100%;
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 0.7rem;
        margin-bottom: 0.7rem;
      }
      .toolbar .color-input {
        width: 2.7rem;
        height: 2.7rem;
        border-radius: 0.5rem;
        border: 2.5px solid #bdbdbd;
        background: #fff !important;
        box-shadow: 0 1px 2px #0001;
        outline: none !important;
        padding: 0;
        display: block;
        appearance: none;
        -webkit-appearance: none;
        cursor: pointer;
        transition: border 0.2s;
      }
      .toolbar .color-input:focus {
        border: 2.5px solid #eebf63;
        outline: none;
        box-shadow: 0 0 0 2px #ffe6b0;
      }
      .toolbar .form-control {
        background: #fff;
        color: #232946;
        border: 1.5px solid #bdbdbd;
        width: 100% !important;
        min-width: 0;
        display: inline-block;
        font-size: 15px;
        border-radius: 0.7rem;
        box-shadow: none;
        padding: 8px 12px;
        margin-bottom: 0.7rem;
      }
      .toolbar .divider {
        width: 90%;
        height: 1.5px;
        background: #e5e7eb;
        margin: 10px 0 10px 0;
        border-radius: 1px;
        align-self: center;
      }
      .selected-shape {
        box-shadow: 0 0 0 3px #0d6efd, 0 0 8px #eebf63;
        border-radius: 8px;
        transition: box-shadow 0.2s;
      }
      #coord-info {
        font-size: 1rem;
        color: #232946;
        background: #ffe6b0;
        border-radius: 8px;
        padding: 4px 12px;
        box-shadow: 0 1px 4px #eebf6320;
        font-weight: 600;
      }
      .toast {
        position: fixed;
        right: 30px;
        bottom: 30px;
        background: #232946;
        color: #fff;
        padding: 12px 24px;
        border-radius: 10px;
        font-size: 1rem;
        z-index: 2000;
        opacity: 0.95;
        box-shadow: 0 2px 12px #0002;
        animation: fadeInOut 2.2s;
      }
      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translateY(30px);
        }
        10% {
          opacity: 1;
          transform: translateY(0);
        }
        90% {
          opacity: 1;
          transform: translateY(0);
        }
        100% {
          opacity: 0;
          transform: translateY(30px);
        }
      }
      .container {
        margin-left: 270px;
        max-width: calc(100vw - 280px);
      }
      .canvas-wrap {
        background: #fff;
        border-radius: 1.2rem;
        box-shadow: 0 2px 12px #eebf6320;
        padding: 2rem;
      }
      canvas {
        border: 2.5px solid #eebf63;
        border-radius: 0.7rem;
        background: #f9fafb;
        transition: box-shadow 0.2s;
        box-shadow: 0 2px 8px #eebf6320;
      }
      .canvas-cursor-select {
        cursor: default !important;
      }
      .toolbar .tool-btn span {
        font-size: 16px;
        font-weight: 600;
        color: #232946;
      }
      .custom-modal {
        position: fixed;
        left: 270px;
        top: 40px;
        z-index: 3000;
        width: 370px;
        max-width: 90vw;
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
        pointer-events: none;
      }
      .custom-modal-card {
        background: #fff;
        border-radius: 1.2rem;
        box-shadow: 0 8px 32px #0002, 0 2px 8px #eebf6320;
        padding: 1.5rem 1.5rem 1.2rem 1.5rem;
        min-width: 340px;
        max-width: 370px;
        pointer-events: all;
        animation: fadeInModal 0.25s;
      }
      @keyframes fadeInModal {
        0% {
          opacity: 0;
          transform: translateY(30px) scale(0.98);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      .custom-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.7rem;
      }
      .custom-modal-title {
        font-size: 1.15rem;
        font-weight: 700;
        color: #232946;
      }
      .custom-modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #232946;
        cursor: pointer;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        transition: background 0.15s;
      }
      .custom-modal-close:hover {
        background: #f3f4f6;
      }
      .custom-modal-desc {
        color: #6b7280;
        font-size: 0.98rem;
        margin-bottom: 0.7rem;
      }
      .custom-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.7rem;
        margin-top: 1.2rem;
      }
      .custom-modal input.form-control {
        border-radius: 0.7rem;
        font-size: 1.08rem;
        padding: 10px 14px;
      }
      .custom-modal .input-group-text {
        background: #f3f4f6;
        border: none;
        color: #232946;
        font-size: 1.1rem;
        border-radius: 0.7rem 0 0 0.7rem;
      }
      .custom-modal .form-label {
        font-weight: 600;
        color: #232946;
        margin-bottom: 0.3rem;
      }
      .custom-modal .form-text {
        color: #e74c3c;
        font-size: 0.95rem;
        margin-top: 0.2rem;
      }
      .form-range {
        accent-color: #eebf63;
        height: 2.2rem;
        background: transparent;
      }
      #size-value {
        font-size: 1.08rem;
        color: #232946;
        display: inline-block;
        min-width: 28px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <div class="toolbar-title">Tools</div>
      <div class="toolbar-group">
        <button
          class="btn tool-btn"
          id="tool-freehand"
          title="Freehand (Pensil)"
        >
          <i class="fas fa-pencil-alt"></i><span>Free</span>
        </button>
        <button class="btn tool-btn" id="tool-line" title="Garis Lurus">
          <i class="fas fa-slash"></i><span>Line</span>
        </button>
        <button class="btn tool-btn" id="tool-rect" title="Persegi Panjang">
          <i class="far fa-square"></i><span>Rect</span>
        </button>
        <button class="btn tool-btn" id="tool-ellipse" title="Elips/Lingkaran">
          <i class="far fa-circle"></i><span>Ellipse</span>
        </button>
        <button
          class="btn tool-btn"
          id="tool-polygon"
          title="Polygon (Banyak Sisi)"
        >
          <i class="fas fa-draw-polygon"></i><span>Poly</span>
        </button>
        <button class="btn tool-btn" id="tool-eraser" title="Penghapus">
          <i class="fas fa-eraser"></i><span>Eraser</span>
        </button>
        <!-- Tambah tombol Text -->
        <button class="btn tool-btn" id="tool-text" title="Tambah Teks">
          <i class="fas fa-font"></i><span>Text</span>
        </button>
      </div>
      <div class="divider"></div>
      <div class="toolbar-group">
        <div class="toolbar-label">Stroke Color</div>
        <div class="color-input-wrap">
          <input
            type="color"
            id="color-picker"
            class="color-input"
            value="#000000"
            title="Pilih warna"
          />
        </div>
        <div class="toolbar-label">Fill Color</div>
        <div class="color-input-wrap">
          <input
            type="color"
            id="fill-picker"
            class="color-input"
            value="#ffffff"
            title="Fill warna"
          />
        </div>
        <div class="toolbar-label">Stroke Size</div>
        <div class="d-flex align-items-center gap-2 mb-2">
          <input
            type="range"
            id="size-slider"
            min="1"
            max="20"
            value="3"
            class="form-range"
            style="width: 110px"
          />
          <span id="size-value" style="font-weight: 600; min-width: 28px"
            >3</span
          >
        </div>
      </div>
      <div class="divider"></div>
      <div class="toolbar-group">
        <button class="btn tool-btn" id="undo-btn" title="Undo (Ctrl+Z)">
          <i class="fas fa-undo"></i><span>Undo</span>
        </button>
        <button class="btn tool-btn" id="redo-btn" title="Redo (Ctrl+Y)">
          <i class="fas fa-redo"></i><span>Redo</span>
        </button>
        <button
          class="btn tool-btn"
          id="delete-btn"
          title="Hapus Shape Terpilih"
        >
          <i class="fas fa-trash"></i><span>Delete</span>
        </button>
        <button
          class="btn tool-btn"
          id="select-btn"
          title="Pilih Shape (Klik di Canvas)"
        >
          <i class="fas fa-mouse-pointer"></i><span>Select</span>
        </button>
      </div>
      <div class="divider"></div>
      <div class="toolbar-group">
        <button
          class="btn tool-btn"
          id="grid-btn"
          title="Tampilkan/Sembunyikan Grid"
        >
          <i class="fas fa-th"></i><span>Grid</span>
        </button>
        <button
          class="btn tool-btn"
          id="translate-btn"
          title="Geser Shape (Translate)"
        >
          <i class="fas fa-arrows-alt"></i><span>Move</span>
        </button>
        <button class="btn tool-btn" id="scale-btn" title="Skalakan Shape">
          <i class="fas fa-expand-arrows-alt"></i><span>Scale</span>
        </button>
        <button class="btn tool-btn" id="rotate-btn" title="Rotasi Shape">
          <i class="fas fa-sync-alt"></i><span>Rotate</span>
        </button>
      </div>
      <div class="divider"></div>
      <div class="toolbar-group">
        <button class="btn tool-btn" id="clear-btn">
          <i class="fas fa-broom"></i><span>Clear</span>
        </button>
        <button class="btn tool-btn" id="save-btn">
          <i class="fas fa-file-image"></i><span>PNG</span>
        </button>
        <button class="btn tool-btn" id="save-svg-btn">
          <i class="fas fa-file-code"></i><span>SVG</span>
        </button>
      </div>
    </div>
    <div class="container py-4">
      <div class="text-center mb-4">
        <h2 class="fw-bold text-primary">Mini Paint Grafika Komputer</h2>
      </div>
      <div class="canvas-wrap d-flex justify-content-center position-relative">
        <canvas
          id="paint-canvas"
          width="900"
          height="500"
          style="box-shadow: 0 4px 24px #eebf6320"
        ></canvas>
        <div id="coord-info" class="position-absolute end-0 bottom-0 p-2"></div>
      </div>
    </div>
    <div id="toast-container"></div>
    <div id="custom-modal" class="custom-modal" style="display: none">
      <div class="custom-modal-card">
        <div class="custom-modal-header">
          <span id="custom-modal-title"></span>
          <button class="custom-modal-close" id="custom-modal-close">
            &times;
          </button>
        </div>
        <div class="custom-modal-body">
          <div id="custom-modal-desc" class="custom-modal-desc"></div>
          <div class="mb-3">
            <label id="custom-modal-label" class="form-label"></label>
            <div class="input-group">
              <span class="input-group-text" id="custom-modal-icon"></span>
              <input
                id="custom-modal-input"
                type="text"
                class="form-control"
                autocomplete="off"
              />
            </div>
            <!-- Tambah font select untuk modal text -->
            <div
              id="custom-modal-font-wrap"
              style="display: none; margin-top: 8px"
            >
              <label class="form-label" for="custom-modal-font">Font</label>
              <select id="custom-modal-font" class="form-control">
                <option value="Arial">Arial</option>
                <option value="Calibri">Calibri</option>
                <option value="Times New Roman">Times New Roman</option>
                <option value="Segoe UI">Segoe UI</option>
                <option value="Tahoma">Tahoma</option>
                <option value="Verdana">Verdana</option>
                <option value="Courier New">Courier New</option>
                <option value="Georgia">Georgia</option>
                <option value="Impact">Impact</option>
                <option value="Comic Sans MS">Comic Sans MS</option>
              </select>
            </div>
            <div id="custom-modal-validation" class="form-text"></div>
          </div>
        </div>
        <div class="custom-modal-footer">
          <button class="btn btn-light" id="custom-modal-cancel">Cancel</button>
          <button class="btn btn-primary" id="custom-modal-accept">
            Accept
          </button>
        </div>
      </div>
    </div>
    <script>
      // Toast notification
      function showToast(msg) {
        let toast = document.createElement("div");
        toast.className = "toast";
        toast.innerText = msg;
        document.getElementById("toast-container").appendChild(toast);
        setTimeout(() => toast.remove(), 2200);
      }

      // State
      let tool = "freehand";
      let drawing = false;
      let startX = 0,
        startY = 0;
      let canvas = document.getElementById("paint-canvas");
      let ctx = canvas.getContext("2d");
      let color = document.getElementById("color-picker").value;
      let fillColor = document.getElementById("fill-picker").value;
      let size = parseInt(document.getElementById("size-slider").value);
      let imgData = null;
      let shapes = [];
      let redoStack = [];
      let selectedIdx = null;
      let showGrid = false;
      let polygonSides = 5;
      // Tambah state untuk text
      let textFont = "Arial";
      let textValue = "";

      // Tool buttons
      function setTool(t) {
        tool = t;
        document
          .querySelectorAll(".tool-btn")
          .forEach((btn) => btn.classList.remove("active"));
        document.getElementById("tool-" + t).classList.add("active");
        // Ubah kursor canvas jika select
        if (t === "select") {
          canvas.classList.add("canvas-cursor-select");
        } else {
          canvas.classList.remove("canvas-cursor-select");
        }
        if (t === "polygon") {
          showCustomModal({
            title: "Polygon Sides",
            desc: "Masukkan jumlah sisi polygon (3-12)",
            label: "Jumlah Sisi",
            icon: '<i class="fas fa-draw-polygon"></i>',
            inputType: "number",
            defaultValue: polygonSides,
            validation: (v) => {
              if (!v || isNaN(v) || v < 3 || v > 12) return "Harus 3-12";
              return "";
            },
            onAccept: (val) => {
              polygonSides = parseInt(val);
            },
          });
        }
      }
      document.getElementById("tool-freehand").onclick = () =>
        setTool("freehand");
      document.getElementById("tool-line").onclick = () => setTool("line");
      document.getElementById("tool-rect").onclick = () => setTool("rect");
      document.getElementById("tool-ellipse").onclick = () =>
        setTool("ellipse");
      document.getElementById("tool-polygon").onclick = () =>
        setTool("polygon");
      document.getElementById("tool-eraser").onclick = () => setTool("eraser");
      // Tambah event untuk tool text
      document.getElementById("tool-text").onclick = () => setTool("text");
      setTool("freehand");

      // Color & size
      document.getElementById("color-picker").oninput = (e) =>
        (color = e.target.value);
      document.getElementById("fill-picker").oninput = (e) =>
        (fillColor = e.target.value);
      // Ganti ke slider
      const sizeSlider = document.getElementById("size-slider");
      const sizeValue = document.getElementById("size-value");
      sizeSlider.oninput = (e) => {
        size = parseInt(e.target.value);
        sizeValue.textContent = size;
      };
      size = parseInt(sizeSlider.value);
      sizeValue.textContent = size;

      // Undo/Redo
      document.getElementById("undo-btn").onclick = () => {
        if (shapes.length > 0) {
          redoStack.push(shapes.pop());
          redraw();
        }
      };
      document.getElementById("redo-btn").onclick = () => {
        if (redoStack.length > 0) {
          shapes.push(redoStack.pop());
          redraw();
        }
      };

      // Delete selected
      document.getElementById("delete-btn").onclick = () => {
        if (selectedIdx !== null && shapes[selectedIdx]) {
          shapes.splice(selectedIdx, 1);
          selectedIdx = null;
          redraw();
        }
      };

      // Select last shape
      document.getElementById("select-btn").onclick = () => {
        if (shapes.length > 0) {
          selectedIdx = shapes.length - 1;
          redraw();
        }
      };

      // Grid toggle
      document.getElementById("grid-btn").onclick = () => {
        showGrid = !showGrid;
        redraw();
      };

      // Transformasi
      document.getElementById("translate-btn").onclick = () => {
        if (selectedIdx === null) {
          showToast("Pilih shape dulu!");
          return;
        }
        showCustomModal({
          title: "Geser Shape",
          desc: "Masukkan dx dan dy (perpindahan)",
          label: "dx,dy",
          icon: '<i class="fas fa-arrows-alt"></i>',
          inputType: "text",
          defaultValue: "20,20",
          validation: (v) => {
            let arr = v.split(",");
            if (arr.length !== 2 || isNaN(arr[0]) || isNaN(arr[1]))
              return "Format: angka,angka";
            return "";
          },
          onAccept: (val) => {
            let [dx, dy] = val.split(",").map(Number);
            let s = shapes[selectedIdx];
            if (s) {
              for (let i = 0; i < s.points.length; i++) {
                s.points[i][0] += dx;
                s.points[i][1] += dy;
              }
              showToast("Shape digeser!");
              redraw();
            }
          },
        });
      };
      document.getElementById("scale-btn").onclick = () => {
        if (selectedIdx === null) {
          showToast("Pilih shape dulu!");
          return;
        }
        showCustomModal({
          title: "Skalakan Shape",
          desc: "Masukkan faktor skala (misal: 1.2)",
          label: "Faktor Skala",
          icon: '<i class="fas fa-expand-arrows-alt"></i>',
          inputType: "number",
          defaultValue: "1.2",
          validation: (v) =>
            !v || isNaN(v) || v <= 0 ? "Harus angka > 0" : "",
          onAccept: (val) => {
            let factor = parseFloat(val);
            let s = shapes[selectedIdx];
            if (s) {
              let cx = 0,
                cy = 0;
              for (let p of s.points) {
                cx += p[0];
                cy += p[1];
              }
              cx /= s.points.length;
              cy /= s.points.length;
              for (let i = 0; i < s.points.length; i++) {
                s.points[i][0] = cx + (s.points[i][0] - cx) * factor;
                s.points[i][1] = cy + (s.points[i][1] - cy) * factor;
              }
              showToast("Shape diskalakan!");
              redraw();
            }
          },
        });
      };
      document.getElementById("rotate-btn").onclick = () => {
        if (selectedIdx === null) {
          showToast("Pilih shape dulu!");
          return;
        }
        showCustomModal({
          title: "Rotasi Shape",
          desc: "Masukkan sudut derajat rotasi",
          label: "Sudut (derajat)",
          icon: '<i class="fas fa-sync-alt"></i>',
          inputType: "number",
          defaultValue: "30",
          validation: (v) => (isNaN(v) ? "Harus angka" : ""),
          onAccept: (val) => {
            let deg = parseFloat(val);
            let rad = (deg * Math.PI) / 180;
            let s = shapes[selectedIdx];
            if (s) {
              let cx = 0,
                cy = 0;
              for (let p of s.points) {
                cx += p[0];
                cy += p[1];
              }
              cx /= s.points.length;
              cy /= s.points.length;
              for (let i = 0; i < s.points.length; i++) {
                let dx = s.points[i][0] - cx,
                  dy = s.points[i][1] - cy;
                s.points[i][0] = cx + dx * Math.cos(rad) - dy * Math.sin(rad);
                s.points[i][1] = cy + dx * Math.sin(rad) + dy * Math.cos(rad);
              }
              showToast("Shape diputar!");
              redraw();
            }
          },
        });
      };

      // Clear
      document.getElementById("clear-btn").onclick = () => {
        shapes = [];
        redoStack = [];
        selectedIdx = null;
        redraw();
      };

      // Save PNG
      document.getElementById("save-btn").onclick = () => {
        let link = document.createElement("a");
        link.download = "mini_paint.png";
        link.href = canvas.toDataURL();
        link.click();
      };

      // Save SVG
      document.getElementById("save-svg-btn").onclick = () => {
        let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${canvas.width}" height="${canvas.height}">`;
        for (let s of shapes) {
          if (s.type === "freehand" || s.type === "eraser") {
            svg += `<polyline points="${s.points
              .map((p) => p.join(","))
              .join(" ")}" stroke="${s.color}" stroke-width="${
              s.size
            }" fill="none"/>`;
          } else if (s.type === "line") {
            svg += `<line x1="${s.points[0][0]}" y1="${s.points[0][1]}" x2="${s.points[1][0]}" y2="${s.points[1][1]}" stroke="${s.color}" stroke-width="${s.size}"/>`;
          } else if (s.type === "rect") {
            let [x0, y0] = s.points[0],
              [x1, y1] = s.points[1];
            svg += `<rect x="${Math.min(x0, x1)}" y="${Math.min(
              y0,
              y1
            )}" width="${Math.abs(x1 - x0)}" height="${Math.abs(
              y1 - y0
            )}" stroke="${s.color}" stroke-width="${s.size}" fill="${
              s.fill
            }"/>`;
          } else if (s.type === "ellipse") {
            let [x0, y0] = s.points[0],
              [x1, y1] = s.points[1];
            svg += `<ellipse cx="${(x0 + x1) / 2}" cy="${(y0 + y1) / 2}" rx="${
              Math.abs(x1 - x0) / 2
            }" ry="${Math.abs(y1 - y0) / 2}" stroke="${
              s.color
            }" stroke-width="${s.size}" fill="${s.fill}"/>`;
          } else if (s.type === "polygon") {
            svg += `<polygon points="${s.points
              .map((p) => p.join(","))
              .join(" ")}" stroke="${s.color}" stroke-width="${s.size}" fill="${
              s.fill
            }"/>`;
          } else if (s.type === "text") {
            svg += `<text x="${s.points[0][0]}" y="${
              s.points[0][1] + s.size * 6
            }" font-family="${s.font}" font-size="${s.size * 6}" fill="${
              s.color
            }">${escapeXML(s.text)}</text>`;
          }
        }
        svg += "</svg>";
        let blob = new Blob([svg], { type: "image/svg+xml" });
        let link = document.createElement("a");
        link.download = "mini_paint.svg";
        link.href = URL.createObjectURL(blob);
        link.click();
      };
      // Helper untuk escape karakter XML pada text SVG
      function escapeXML(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&apos;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      // Drawing logic
      let tempPoints = [];
      canvas.onmousedown = function (e) {
        drawing = true;
        startX = e.offsetX;
        startY = e.offsetY;
        imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        tempPoints = [[startX, startY]];
        if (tool === "freehand" || tool === "eraser") {
          ctx.beginPath();
          ctx.moveTo(startX, startY);
        }
        // Tambah: jika tool text, tampilkan modal input text
        if (tool === "text") {
          drawing = false;
          showCustomModal({
            title: "Tambah Teks",
            desc: "Masukkan teks dan pilih font",
            label: "Teks",
            icon: '<i class="fas fa-font"></i>',
            inputType: "text",
            defaultValue: "",
            fontSelect: true,
            validation: (v) => (!v ? "Teks tidak boleh kosong" : ""),
            onAccept: (val, font) => {
              textValue = val;
              textFont = font;
              shapes.push({
                type: "text",
                points: [[startX, startY]],
                color: color,
                size: size,
                text: textValue,
                font: textFont,
              });
              redoStack = [];
              redraw();
            },
          });
        }
      };
      canvas.onmousemove = function (e) {
        let x = e.offsetX,
          y = e.offsetY;
        document.getElementById("coord-info").textContent = `x: ${x}, y: ${y}`;
        if (!drawing) return;
        ctx.lineWidth = size;
        ctx.strokeStyle = tool === "eraser" ? "#fff" : color;
        ctx.fillStyle = fillColor;
        ctx.lineCap = "round";
        if (tool === "freehand" || tool === "eraser") {
          ctx.lineTo(x, y);
          ctx.stroke();
          tempPoints.push([x, y]);
        } else {
          ctx.putImageData(imgData, 0, 0);
          if (tool === "line") {
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(x, y);
            ctx.stroke();
          } else if (tool === "rect") {
            ctx.strokeRect(startX, startY, x - startX, y - startY);
            if (fillColor !== "#ffffff") {
              ctx.globalAlpha = 0.3;
              ctx.fillStyle = fillColor;
              ctx.fillRect(startX, startY, x - startX, y - startY);
              ctx.globalAlpha = 1.0;
            }
          } else if (tool === "ellipse") {
            ctx.beginPath();
            ctx.ellipse(
              (startX + x) / 2,
              (startY + y) / 2,
              Math.abs(x - startX) / 2,
              Math.abs(y - startY) / 2,
              0,
              0,
              2 * Math.PI
            );
            ctx.stroke();
            if (fillColor !== "#ffffff") {
              ctx.globalAlpha = 0.3;
              ctx.fill();
              ctx.globalAlpha = 1.0;
            }
          } else if (tool === "polygon") {
            let pts = getPolygonPoints(startX, startY, x, y, polygonSides);
            ctx.beginPath();
            ctx.moveTo(pts[0][0], pts[0][1]);
            for (let i = 1; i < pts.length; i++)
              ctx.lineTo(pts[i][0], pts[i][1]);
            ctx.closePath();
            ctx.stroke();
            if (fillColor !== "#ffffff") {
              ctx.globalAlpha = 0.3;
              ctx.fill();
              ctx.globalAlpha = 1.0;
            }
          }
        }
      };
      canvas.onmouseup = function (e) {
        if (!drawing) return;
        drawing = false;
        let x = e.offsetX,
          y = e.offsetY;
        ctx.lineWidth = size;
        ctx.strokeStyle = tool === "eraser" ? "#fff" : color;
        ctx.fillStyle = fillColor;
        ctx.lineCap = "round";
        if (tool === "freehand" || tool === "eraser") {
          ctx.lineTo(x, y);
          ctx.stroke();
          ctx.closePath();
          shapes.push({
            type: tool,
            points: tempPoints.slice(),
            color: tool === "eraser" ? "#fff" : color,
            size: size,
            fill: "#fff",
          });
        } else if (tool === "line") {
          ctx.putImageData(imgData, 0, 0);
          ctx.beginPath();
          ctx.moveTo(startX, startY);
          ctx.lineTo(x, y);
          ctx.stroke();
          shapes.push({
            type: "line",
            points: [
              [startX, startY],
              [x, y],
            ],
            color: color,
            size: size,
            fill: "#fff",
          });
        } else if (tool === "rect") {
          ctx.putImageData(imgData, 0, 0);
          ctx.strokeRect(startX, startY, x - startX, y - startY);
          if (fillColor !== "#ffffff") {
            ctx.globalAlpha = 0.3;
            ctx.fillStyle = fillColor;
            ctx.fillRect(startX, startY, x - startX, y - startY);
            ctx.globalAlpha = 1.0;
          }
          shapes.push({
            type: "rect",
            points: [
              [startX, startY],
              [x, y],
            ],
            color: color,
            size: size,
            fill: fillColor,
          });
        } else if (tool === "ellipse") {
          ctx.putImageData(imgData, 0, 0);
          ctx.beginPath();
          ctx.ellipse(
            (startX + x) / 2,
            (startY + y) / 2,
            Math.abs(x - startX) / 2,
            Math.abs(y - startY) / 2,
            0,
            0,
            2 * Math.PI
          );
          ctx.stroke();
          if (fillColor !== "#ffffff") {
            ctx.globalAlpha = 0.3;
            ctx.fill();
            ctx.globalAlpha = 1.0;
          }
          shapes.push({
            type: "ellipse",
            points: [
              [startX, startY],
              [x, y],
            ],
            color: color,
            size: size,
            fill: fillColor,
          });
        } else if (tool === "polygon") {
          ctx.putImageData(imgData, 0, 0);
          let pts = getPolygonPoints(startX, startY, x, y, polygonSides);
          ctx.beginPath();
          ctx.moveTo(pts[0][0], pts[0][1]);
          for (let i = 1; i < pts.length; i++) ctx.lineTo(pts[i][0], pts[i][1]);
          ctx.closePath();
          ctx.stroke();
          if (fillColor !== "#ffffff") {
            ctx.globalAlpha = 0.3;
            ctx.fill();
            ctx.globalAlpha = 1.0;
          }
          shapes.push({
            type: "polygon",
            points: pts,
            color: color,
            size: size,
            fill: fillColor,
          });
        } else if (tool === "text") {
          ctx.putImageData(imgData, 0, 0);
          ctx.save();
          ctx.font = `${size * 6}px "${textFont}"`;
          ctx.fillStyle = color;
          ctx.textBaseline = "top";
          ctx.fillText(textValue, startX, startY);
          ctx.restore();
          shapes.push({
            type: "text",
            points: [[startX, startY]],
            color: color,
            size: size,
            text: textValue,
            font: textFont,
          });
        }
        redoStack = [];
        redraw();
      };
      canvas.onmouseleave = function () {
        drawing = false;
      };

      // Polygon points helper
      function getPolygonPoints(x0, y0, x1, y1, n) {
        let cx = (x0 + x1) / 2,
          cy = (y0 + y1) / 2;
        let rx = Math.abs(x1 - x0) / 2,
          ry = Math.abs(y1 - y0) / 2;
        let pts = [];
        for (let i = 0; i < n; i++) {
          let angle = (2 * Math.PI * i) / n - Math.PI / 2;
          pts.push([cx + rx * Math.cos(angle), cy + ry * Math.sin(angle)]);
        }
        return pts;
      }

      // Redraw all shapes
      function redraw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (showGrid) drawGrid();
        for (let i = 0; i < shapes.length; i++) {
          let s = shapes[i];
          ctx.lineWidth = s.size;
          ctx.strokeStyle = s.color;
          ctx.fillStyle = s.fill || "#fff";
          ctx.lineCap = "round";
          if (s.type === "freehand" || s.type === "eraser") {
            ctx.beginPath();
            ctx.moveTo(s.points[0][0], s.points[0][1]);
            for (let j = 1; j < s.points.length; j++)
              ctx.lineTo(s.points[j][0], s.points[j][1]);
            ctx.stroke();
          } else if (s.type === "line") {
            ctx.beginPath();
            ctx.moveTo(s.points[0][0], s.points[0][1]);
            ctx.lineTo(s.points[1][0], s.points[1][1]);
            ctx.stroke();
          } else if (s.type === "rect") {
            let [x0, y0] = s.points[0],
              [x1, y1] = s.points[1];
            ctx.strokeRect(x0, y0, x1 - x0, y1 - y0);
            if (s.fill && s.fill !== "#ffffff") {
              ctx.globalAlpha = 0.3;
              ctx.fillStyle = s.fill;
              ctx.fillRect(x0, y0, x1 - x0, y1 - y0);
              ctx.globalAlpha = 1.0;
            }
          } else if (s.type === "ellipse") {
            let [x0, y0] = s.points[0],
              [x1, y1] = s.points[1];
            ctx.beginPath();
            ctx.ellipse(
              (x0 + x1) / 2,
              (y0 + y1) / 2,
              Math.abs(x1 - x0) / 2,
              Math.abs(y1 - y0) / 2,
              0,
              0,
              2 * Math.PI
            );
            ctx.stroke();
            if (s.fill && s.fill !== "#ffffff") {
              ctx.globalAlpha = 0.3;
              ctx.fill();
              ctx.globalAlpha = 1.0;
            }
          } else if (s.type === "polygon") {
            let pts = s.points;
            ctx.beginPath();
            ctx.moveTo(pts[0][0], pts[0][1]);
            for (let j = 1; j < pts.length; j++)
              ctx.lineTo(pts[j][0], pts[j][1]);
            ctx.closePath();
            ctx.stroke();
            if (s.fill && s.fill !== "#ffffff") {
              ctx.globalAlpha = 0.3;
              ctx.fill();
              ctx.globalAlpha = 1.0;
            }
          } else if (s.type === "text") {
            ctx.save();
            ctx.font = `${s.size * 6}px "${s.font}"`;
            ctx.fillStyle = s.color;
            ctx.textBaseline = "top";
            ctx.fillText(s.text, s.points[0][0], s.points[0][1]);
            ctx.restore();
          }
          // Highlight selected
          if (i === selectedIdx) {
            ctx.save();
            ctx.strokeStyle = "#0d6efd";
            ctx.lineWidth = 2.5;
            ctx.setLineDash([6, 4]);
            ctx.shadowColor = "#eebf63";
            ctx.shadowBlur = 8;
            if (s.type === "rect") {
              let [x0, y0] = s.points[0],
                [x1, y1] = s.points[1];
              ctx.strokeRect(x0, y0, x1 - x0, y1 - y0);
            } else if (s.type === "ellipse") {
              let [x0, y0] = s.points[0],
                [x1, y1] = s.points[1];
              ctx.beginPath();
              ctx.ellipse(
                (x0 + x1) / 2,
                (y0 + y1) / 2,
                Math.abs(x1 - x0) / 2,
                Math.abs(y1 - y0) / 2,
                0,
                0,
                2 * Math.PI
              );
              ctx.stroke();
            } else if (s.type === "polygon") {
              let pts = s.points;
              ctx.beginPath();
              ctx.moveTo(pts[0][0], pts[0][1]);
              for (let j = 1; j < pts.length; j++)
                ctx.lineTo(pts[j][0], pts[j][1]);
              ctx.closePath();
              ctx.stroke();
            } else if (s.type === "line") {
              ctx.beginPath();
              ctx.moveTo(s.points[0][0], s.points[0][1]);
              ctx.lineTo(s.points[1][0], s.points[1][1]);
              ctx.stroke();
            } else if (s.type === "freehand" || s.type === "eraser") {
              ctx.beginPath();
              ctx.moveTo(s.points[0][0], s.points[0][1]);
              for (let j = 1; j < s.points.length; j++)
                ctx.lineTo(s.points[j][0], s.points[j][1]);
              ctx.stroke();
            } else if (s.type === "text") {
              // Garis kotak highlight sekitar text
              let metrics = ctx.measureText(s.text);
              let w = metrics.width;
              let h = s.size * 6;
              ctx.strokeRect(s.points[0][0], s.points[0][1], w, h);
            }
            ctx.setLineDash([]);
            ctx.shadowBlur = 0;
            ctx.restore();
          }
        }
      }

      // Draw grid
      function drawGrid() {
        ctx.save();
        ctx.strokeStyle = "#eee";
        ctx.lineWidth = 1;
        for (let x = 0; x < canvas.width; x += 25) {
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, canvas.height);
          ctx.stroke();
        }
        for (let y = 0; y < canvas.height; y += 25) {
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(canvas.width, y);
          ctx.stroke();
        }
        ctx.restore();
      }

      // Select shape by click (hanya aktif jika tool == 'select')
      canvas.addEventListener("click", function (e) {
        if (tool !== "select") return;
        let x = e.offsetX,
          y = e.offsetY;
        let found = null;
        // Cek dari atas ke bawah agar shape paling atas yang terpilih
        for (let i = shapes.length - 1; i >= 0; i--) {
          let s = shapes[i];
          if (isPointInShape(x, y, s)) {
            found = i;
            break;
          }
        }
        if (found !== null) {
          selectedIdx = found;
          showToast("Shape terpilih!");
        } else {
          selectedIdx = null;
        }
        redraw();
      });

      // Helper: cek point dalam shape
      function isPointInShape(x, y, s) {
        if (s.type === "rect") {
          let [x0, y0] = s.points[0],
            [x1, y1] = s.points[1];
          let minX = Math.min(x0, x1),
            maxX = Math.max(x0, x1);
          let minY = Math.min(y0, y1),
            maxY = Math.max(y0, y1);
          return x >= minX && x <= maxX && y >= minY && y <= maxY;
        } else if (s.type === "ellipse") {
          let [x0, y0] = s.points[0],
            [x1, y1] = s.points[1];
          let cx = (x0 + x1) / 2,
            cy = (y0 + y1) / 2;
          let rx = Math.abs(x1 - x0) / 2,
            ry = Math.abs(y1 - y0) / 2;
          if (rx === 0 || ry === 0) return false;
          return (x - cx) ** 2 / rx ** 2 + (y - cy) ** 2 / ry ** 2 <= 1.1;
        } else if (s.type === "polygon") {
          return pointInPolygon([x, y], s.points);
        } else if (s.type === "line") {
          let [a, b] = s.points;
          let dist = pointLineDist(x, y, a, b);
          return dist < Math.max(6, s.size + 2);
        } else if (s.type === "freehand" || s.type === "eraser") {
          for (let i = 1; i < s.points.length; i++) {
            let a = s.points[i - 1],
              b = s.points[i];
            if (pointLineDist(x, y, a, b) < Math.max(6, s.size + 2))
              return true;
          }
        } else if (s.type === "text") {
          // Deteksi klik pada text
          ctx.save();
          ctx.font = `${s.size * 6}px "${s.font}"`;
          let w = ctx.measureText(s.text).width;
          let h = s.size * 6;
          ctx.restore();
          let [tx, ty] = s.points[0];
          return x >= tx && x <= tx + w && y >= ty && y <= ty + h;
        }
        return false;
      }
      function pointLineDist(x, y, a, b) {
        let A = x - a[0],
          B = y - a[1],
          C = b[0] - a[0],
          D = b[1] - a[1];
        let dot = A * C + B * D;
        let len_sq = C * C + D * D;
        let param = len_sq ? dot / len_sq : -1;
        let xx, yy;
        if (param < 0) {
          xx = a[0];
          yy = a[1];
        } else if (param > 1) {
          xx = b[0];
          yy = b[1];
        } else {
          xx = a[0] + param * C;
          yy = a[1] + param * D;
        }
        let dx = x - xx,
          dy = y - yy;
        return Math.sqrt(dx * dx + dy * dy);
      }
      function pointInPolygon(pt, poly) {
        let c = false,
          n = poly.length;
        for (let i = 0, j = n - 1; i < n; j = i++) {
          if (
            poly[i][1] > pt[1] !== poly[j][1] > pt[1] &&
            pt[0] <
              ((poly[j][0] - poly[i][0]) * (pt[1] - poly[i][1])) /
                (poly[j][1] - poly[i][1]) +
                poly[i][0]
          )
            c = !c;
        }
        return c;
      }

      // Custom modal
      function showModal(title, desc, inputLabel, inputValue, inputIcon) {
        document.getElementById("custom-modal-title").innerText = title;
        document.getElementById("custom-modal-desc").innerText = desc;
        document.getElementById("custom-modal-label").innerText = inputLabel;
        document.getElementById("custom-modal-input").value = inputValue;
        document.getElementById("custom-modal-icon").innerText = inputIcon;
        document.getElementById("custom-modal-validation").innerText = "";
        document.getElementById("custom-modal").style.display = "flex";
      }
      document.getElementById("custom-modal-close").onclick = () => {
        document.getElementById("custom-modal").style.display = "none";
      };
      document.getElementById("custom-modal-cancel").onclick = () => {
        document.getElementById("custom-modal").style.display = "none";
      };
      document.getElementById("custom-modal-accept").onclick = () => {
        let input = document.getElementById("custom-modal-input");
        let value = input.value.trim();
        if (value === "") {
          document.getElementById("custom-modal-validation").innerText =
            "Input tidak boleh kosong";
          input.focus();
          return;
        }
        document.getElementById("custom-modal").style.display = "none";
        // Lanjutkan dengan aksi yang sesuai, misalnya:
        // if (currentAction === "translate") { ... }
        // else if (currentAction === "scale") { ... }
        // else if (currentAction === "rotate") { ... }
      };

      // Custom Modal Logic
      function showCustomModal({
        title = "",
        desc = "",
        label = "",
        icon = "",
        inputType = "text",
        defaultValue = "",
        validation = null,
        onAccept = null,
        fontSelect = false,
      }) {
        document.getElementById("custom-modal-title").textContent = title;
        document.getElementById("custom-modal-desc").textContent = desc;
        document.getElementById("custom-modal-label").textContent = label;
        document.getElementById("custom-modal-icon").innerHTML = icon;
        const input = document.getElementById("custom-modal-input");
        input.type = inputType;
        input.value = defaultValue;
        document.getElementById("custom-modal-validation").textContent = "";
        // Tampilkan/hide font select
        const fontWrap = document.getElementById("custom-modal-font-wrap");
        fontWrap.style.display = fontSelect ? "block" : "none";
        if (fontSelect) {
          document.getElementById("custom-modal-font").value = "Arial";
        }
        document.getElementById("custom-modal").style.display = "flex";
        input.focus();
        function closeModal() {
          document.getElementById("custom-modal").style.display = "none";
        }
        function accept() {
          let val = input.value;
          let font = "Arial";
          if (fontSelect) {
            font = document.getElementById("custom-modal-font").value;
          }
          if (validation) {
            let msg = validation(val);
            if (msg) {
              document.getElementById("custom-modal-validation").textContent =
                msg;
              input.focus();
              return;
            }
          }
          closeModal();
          if (onAccept) onAccept(val, font);
        }
        document.getElementById("custom-modal-accept").onclick = accept;
        document.getElementById("custom-modal-cancel").onclick = closeModal;
        document.getElementById("custom-modal-close").onclick = closeModal;
        input.onkeydown = function (e) {
          if (e.key === "Enter") accept();
          if (e.key === "Escape") closeModal();
        };
      }

      // Save SVG
      document.getElementById("save-svg-btn").onclick = () => {
        let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${canvas.width}" height="${canvas.height}">`;
        for (let s of shapes) {
          if (s.type === "freehand" || s.type === "eraser") {
            svg += `<polyline points="${s.points
              .map((p) => p.join(","))
              .join(" ")}" stroke="${s.color}" stroke-width="${
              s.size
            }" fill="none"/>`;
          } else if (s.type === "line") {
            svg += `<line x1="${s.points[0][0]}" y1="${s.points[0][1]}" x2="${s.points[1][0]}" y2="${s.points[1][1]}" stroke="${s.color}" stroke-width="${s.size}"/>`;
          } else if (s.type === "rect") {
            let [x0, y0] = s.points[0],
              [x1, y1] = s.points[1];
            svg += `<rect x="${Math.min(x0, x1)}" y="${Math.min(
              y0,
              y1
            )}" width="${Math.abs(x1 - x0)}" height="${Math.abs(
              y1 - y0
            )}" stroke="${s.color}" stroke-width="${s.size}" fill="${
              s.fill
            }"/>`;
          } else if (s.type === "ellipse") {
            let [x0, y0] = s.points[0],
              [x1, y1] = s.points[1];
            svg += `<ellipse cx="${(x0 + x1) / 2}" cy="${(y0 + y1) / 2}" rx="${
              Math.abs(x1 - x0) / 2
            }" ry="${Math.abs(y1 - y0) / 2}" stroke="${
              s.color
            }" stroke-width="${s.size}" fill="${s.fill}"/>`;
          } else if (s.type === "polygon") {
            svg += `<polygon points="${s.points
              .map((p) => p.join(","))
              .join(" ")}" stroke="${s.color}" stroke-width="${s.size}" fill="${
              s.fill
            }"/>`;
          } else if (s.type === "text") {
            svg += `<text x="${s.points[0][0]}" y="${
              s.points[0][1] + s.size * 6
            }" font-family="${s.font}" font-size="${s.size * 6}" fill="${
              s.color
            }">${escapeXML(s.text)}</text>`;
          }
        }
        svg += "</svg>";
        let blob = new Blob([svg], { type: "image/svg+xml" });
        let link = document.createElement("a");
        link.download = "mini_paint.svg";
        link.href = URL.createObjectURL(blob);
        link.click();
      };
    </script>
  </body>
</html>
